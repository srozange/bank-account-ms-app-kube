apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-istio-config
  namespace: bank-account
data:
  config.yaml: |
    plugins:
      envoy_ext_authz_grpc:
        addr: :9191
        path: istio/authz/allow
    decision_logs:
      console: true
    # Activer les logs de diagnostic
    status:
      console: true
    # Log level debug
    default_decision: /istio/authz/allow

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policy
  namespace: bank-account
data:
  policy.rego: |
    package istio.authz

    import input.attributes.request.http as http_request

    default allow = true

    # Extraire le username
    user_name = parsed {
        [_, encoded] := split(http_request.headers.authorization, " ")
        [parsed, _] := split(base64url.decode(encoded), ":")
    }

    deny {
        user_name == "srozange"
        startswith(http_request.host, "bank-customer-service")    
    }

    allow = false {
        deny
    }

    # Debug
    debug_info = {
        "user_name": user_name,
        "deny": deny,
        "allow": allow,
        "host": http_request.host
    }